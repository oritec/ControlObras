{% extends "base.html" %}
{% load staticfiles %}
{% load customtags %}
{% load tz %}
{% block css %}
    <!-- BEGIN PAGE LEVEL STYLES -->
    <link href="{% static 'common/assets/global/plugins/bootstrap-select/css/bootstrap-select.min.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'common/assets/global/plugins/bootstrap-datepicker/css/bootstrap-datepicker3.min.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'common/JQuery-File-Upload/css/jquery.fileupload.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'common/JQuery-File-Upload/css/jquery.fileupload-ui.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'common/assets/global/plugins/bootstrap-switch/css/bootstrap-switch.min.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'common/Magnific-Popup/magnific-popup.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'common/assets/global/plugins/datatables/datatables.min.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'common/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.css' %}" rel="stylesheet" type="text/css" />
    <link href="{% static 'common/assets/global/plugins/jquery-multi-select/css/multi-select.css' %}" rel="stylesheet" type="text/css" />

    <!-- END PAGE LEVEL STYLES -->
{% endblock %}

{% block breadcrumb %}
    <li>
        <a href={% url 'ncr:observaciones-resumen' parque.slug %}>NCR</a>
        <i class="fa fa-circle"></i>
    </li>
    <li>
        <a href={% url 'ncr:observaciones' parque.slug observacion.aerogenerador.slug %}> {{ observacion.aerogenerador }} </a>
        <i class="fa fa-circle"></i>
    </li>
    <li>
        <span>Detalle Observación </span>
    </li>
{% endblock %}

{% block contenido %}

<div class="row">
    {% if parque.no_aerogeneradores == 0 %}
        <div class="col-md-11 col-md-offset-1">
            <h4>Por favor, ingresar la informaci&oacute;n del parque (Configuraci&oacute;n).</h4>
        </div>
    {%  else %}
        {% if observacion.cerrado %}
            <div class="note note-danger" style="margin-left:10px;margin-right:10px;">
            {% if observacion.msg_cerrado == '' %}
                <p style="font-weight: bold"> Observaci&oacute;n cerrada sin comentarios. </p>
            {% else %}
                <p style="font-weight: bold"> Observaci&oacute;n cerrada. Raz&oacute;n: {{ observacion.msg_cerrado }} </p>
            {% endif %}
            </div>
        {% endif %}
        {% for revision in observacion.revision_set.all %}
        <div class="note note-info" style="margin-left:10px;margin-right:10px;">
            <div class = "row">
                <div class="col-md-3">
                    <a href="javascript:;" class="thumbnail">
                        {% if fotos|get_item:revision.id %}
                            <img src="{{ main_fotos|get_item:revision.id  }}" alt="foto" name="galeria" id="thumbnail-{{ revision.id }}"/>
                        {% else %}
                            <img src="{% static 'common/images/photo_add6.png' %}" alt="foto" name="galeria" id="thumbnail-{{ revision.id }}"/>
                        {% endif %}
                    </a>
                    <row>
                        {% if perms.ncr.change_revision or user == observacion.created_by or user == revision.created_by %}
                        <a data-toggle="modal" href="#long" class="btn btn-sm green" id="addPhotoModal-{{ revision.id }}" name="addPhoto" onclick="$('#fileupload').attr('action','{% url 'ncr:imagenes-agregar' parque.slug revision.id %}');">
                            <i class="fa fa-plus"></i> Fotos
                        </a>
                        <a data-toggle="modal" href="#imagenes" class="btn btn-sm purple-plum" id="configPhotoModal-{{ revision.id }}" name="configImages" data-url="{% url 'ncr:imagenes-listado' parque.slug revision.id %}">
                            <i class="fa fa-wrench"></i> Fotos
                        </a>
                        {% endif %}
                        <a  class="btn btn-sm grey" name="galeria" id="galeria-{{ revision.id }}">
                            <i class="fa fa-image"></i> Galer&iacute;a
                        </a>
                    </row>

                </div>
                {% if forloop.first %}
                    <div class="col-md-9">
                        <h4 class="block">Revisi&oacute;n {{ forloop.counter }} - Fecha: {{ revision.fecha_revision }}
                            {% if perms.ncr.change_observacion or user == observacion.created_by %}
                            <a href="{% url 'ncr:observaciones-editar' parque.slug observacion.id %}" class="btn btn-circle btn-xs blue" style="margin-left: 10px"> Editar
                                <i class="fa fa-edit"></i>
                            </a>
                            {% endif %}
                            {% if perms.ncr.delete_observacion or user == observacion.created_by %}
                            <input type="button" id="del_observacion{{ observacion.id }}" data-target="#basic1" data-toggle="modal" class="btn btn-xs btn-circle red" value="Borrar" onclick="$('#del_id').val({{ observacion.id }})"/>
                            {% endif %}
                        </h4>
                        <ul>
                            <li> <b>Aerogenerador:</b> {{ observacion.aerogenerador }} </li>
                            <li> <b>Categoría:</b> {% if observacion.clase %} NCR {% else %} Sin Categoría {% endif %} </li>
                            <li> <b>Componente:</b> {{ observacion.componente }}</li>
                            <li> <b>N&uacute;mero de Serie:</b> {% if observacion.no_serie == '' %} - {% else %}{{ observacion.no_serie }} {% endif %}</li>
                            <li> <b>Sub-Componente:</b> {{ observacion.sub_componente }}</li>
                            <li> <b>Tipo:</b> {{ observacion.tipo }}</li>
                            <li> <b>Severidad:</b> {{ revision.severidad }}</li>
                            <li> <b>Prioridad:</b> {{ observacion.prioridad }}</li>
                            <li> <b>Descipci&oacute;n:</b> {{ observacion.nombre }}</li>
                            <li> <b>Detalle:</b> {{ revision.descripcion }}</li>
                            <li> <b>Punchlist:</b> {% if observacion.punchlist %} S&iacute; {% else %} No {% endif %}</li>
                            <li> <b>Reportado por:</b> {% if observacion.reported_by  %}{{ observacion.reported_by }}{% else %}-{% endif %}</li>
                            <li> <b>Creado por:</b> {{ observacion.created_by }} </li>
                        </ul>
                    </div>
                {% else %}
                    <div class="col-md-9">
                        <h4 class="block">Revisi&oacute;n {{ forloop.counter }} - Fecha: {{ revision.fecha_revision }}
                        {% if perms.ncr.change_revision or user == revision.created_by %}
                        <a href="{% url 'ncr:revisiones-editar' parque.slug observacion.id revision.id %}" class="btn btn-circle btn-xs blue" style="margin-left: 10px"> Editar
                            <i class="fa fa-edit"></i>
                        </a>
                        {% endif %}
                        {% if perms.ncr.delete_revision or user == revision.created_by %}
                        <input type="button" id="del_revision{{ revision.id }}" data-target="#basic2" data-toggle="modal" class="btn btn-xs btn-circle red" value="Borrar" onclick="$('#del_id_rev').val({{ revision.id }})"/>
                        {% endif %}
                        </h4>
                        <ul>
                            <li> <b>Estado:</b> {{ revision.estado }}</li>
                            <li> <b>Severidad:</b> {{ revision.severidad }}</li>
                            <li> <b>Prioridad:</b> {{ revision.prioridad }}</li>
                            <li> <b>Descripci&oacute;n:</b> {{ revision.nombre }}</li>
                            <li> <b>Detalle:</b> {% if revision.descripcion is not None %}{{ revision.descripcion }}{% else %} - {% endif %}</li>
                            <li> <b>Reportado por:</b> {% if revision.reported_by  %}{{ revision.reported_by }}{% else %}-{% endif %} </li>
                            <li> <b>Creado por:</b> {{ revision.created_by }} </li>
                        </ul>
                    </div>
                {% endif %}
            </div>
        </div>
        {% if forloop.last %}
            {% if not observacion.cerrado %}
                <div class="row">
                    <div class="col-md-12">
                        {% if perms.ncr.add_revision %}
                        <a href="{% url 'ncr:revisiones-add' parque.slug observacion.id %}" class="btn btn-sm blue" style="margin-left:10px;">
                            Agregar Revisi&oacute;n <i class="fa fa-plus"></i>
                        </a>
                        {% endif %}
                        {% if perms.ncr.change_observacion or user == observacion.created_by %}
                        {% if observacion.estado.nombre == 'Solucionado' %}
                        <a id="closeSafe" class="btn btn-sm grey-mint" style="margin-left:10px;margin-right:10px;">
                            Cerrar Observaci&oacute;n <i class="fa fa-check-square-o"></i>
                        </a>
                        {% else %}
                        <a href="" id="close_{{ observacion.id }}" data-target="#basic3" data-toggle="modal" class="btn btn-sm grey-mint" style="margin-left:10px;margin-right:10px;" onclick="$('#del_id_obs').val({{ observacion.id }});$('#cierre_msg').val('');">
                            Cerrar Observaci&oacute;n <i class="fa fa-check-square-o"></i>
                        </a>
                        {% endif %}
                        {% endif %}
                        <a href="{% url 'ncr:observaciones-show' parque.slug observacion.id %}?printable=true" class="btn btn-sm grey-salt" target="_blank">
                            Vista Impresi&oacute;n <i class="fa fa-print"></i>
                        </a>
                        {% if perms.ncr.add_revision %}
                        <a data-toggle="modal" href="#duplicar" class="btn btn-sm purple-plum" style="margin-left:10px;">
                            Duplicar Observaci&oacute;n <i class="fa fa-copy"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            {% else %}
                <div class="row">
                    <div class="col-md-12">
                        <a href="" id="close_{{ observacion.id }}" data-target="#basic4" data-toggle="modal" class="btn btn-sm grey-mint" style="margin-left:10px;margin-right:10px;" onclick="$('#del_id_obs2').val({{ observacion.id }})">
                            Abrir Observaci&oacute;n <i class="fa fa-check-square-o"></i>
                        </a>
                    </div>
                </div>
            {% endif %}
        {% endif %}
        {% endfor %}
    {% endif %}

</div>


<div id="imagenes" class="modal fade bs-modal-lg modal-scroll" tabindex="-1" data-replace="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title"> Administrar Im&aacute;genes  </h4> <h5>(Click y arrastrar para seleccionar orden)</h5>
            </div>
            <div class="modal-body">
                <table class="table table-striped table-hover table-bordered" id="tabla-imagenes">
                    <thead>
                        <tr>
                            <th> Seq </th>
                            <th> Foto </th>
                            <th> Incluir en Informe? </th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="long" class="modal fade bs-modal-lg modal-scroll" tabindex="-1" data-replace="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">Agregar Im&aacute;genes </h4>
            </div>
            <div class="modal-body">
                <form id="fileupload" action="" method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    <!-- The fileupload-buttonbar contains buttons to add/delete files and start/cancel the upload -->
                    <div class="row fileupload-buttonbar">
                        <div class="col-md-12">
                            <!-- The fileinput-button span is used to style the file input field as button -->
                            <span class="btn btn-success fileinput-button">
                                <i class="glyphicon glyphicon-plus"></i>
                                <span>Agregar archivos...</span>
                                <input type="file" name="files[]" multiple>
                            </span>
                            <button type="submit" class="btn btn-primary start">
                                <i class="glyphicon glyphicon-upload"></i>
                                <span>Subir archivos</span>
                            </button>
                            <button type="button" class="btn btn-danger delete">
                                <i class="glyphicon glyphicon-trash"></i>
                                <span>Borrar</span>
                            </button>
                            <input type="checkbox" class="toggle">
                            <!-- The global file processing state -->
                            <span class="fileupload-process"></span>
                        </div>
                        <!-- The global progress state -->
                        <div class="col-lg-5 fileupload-progress fade">
                            <!-- The global progress bar -->
                            <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                                <div class="progress-bar progress-bar-success" style="width:0%;"></div>
                            </div>
                            <!-- The extended global progress state -->
                            <div class="progress-extended">&nbsp;</div>
                        </div>
                    </div>
                    <!-- The table listing the files available for upload/download -->
                    <table role="presentation" class="table table-striped"><tbody class="files"></tbody></table>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" data-dismiss="modal" class="btn dark btn-outline">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="basic1" tabindex="-1" role="basic" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">
                    <span class="glyphicon glyphicon-exclamation-sign" style="color:rgba(255, 63, 0, 0.89);font-size:20px"></span>
                     <b>Advertencia</b> </h4>
            </div>
            <div class="modal-body">
                 <h5><b>&iquest;Desea borrar la observación? Esto eliminará todas las revisiones e imágenes.</b> </h5>
            </div>
            <div class="modal-footer">

                <form action="{% url 'ncr:observaciones-eliminar' parque.slug %}" method="post" id="formDelObservacion">
                    {% csrf_token %}
                    <input type="hidden" name="del_id" id="del_id" value="">
                    <input type="hidden" name="back_url" id="back_url" value="">
                    <button type="button" class="btn default" data-dismiss="modal">Cancelar</button>
                    <button type="submit" id='enviarmodal' class="btn red" name="FromList">Borrar</button>
                    <!--<a href="" id='enviarmodal' class="btn btn-success success">Save Changes</a>-->
                </form>
                <!--<button type="button" id="enviarmodal" class="btn blue">Save changes</button>-->

            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>

<div class="modal fade" id="basic2" tabindex="-1" role="basic" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">
                    <span class="glyphicon glyphicon-exclamation-sign" style="color:rgba(255, 63, 0, 0.89);font-size:20px"></span>
                     <b>Advertencia</b> </h4>
            </div>
            <div class="modal-body">
                 <h5><b>&iquest;Desea borrar la revisión? Esto eliminará todas las imágenes.</b> </h5>
            </div>
            <div class="modal-footer">

                <form action="{% url 'ncr:revision-eliminar' parque.slug %}" method="post" id="formDelRevision">
                    {% csrf_token %}
                    <input type="hidden" name="del_id" id="del_id_rev" value="">
                    <input type="hidden" name="back_url" id="back_url" value="">
                    <button type="button" class="btn default" data-dismiss="modal">Cancelar</button>
                    <button type="submit" id='enviarmodal' class="btn red" name="FromList">Borrar</button>
                    <!--<a href="" id='enviarmodal' class="btn btn-success success">Save Changes</a>-->
                </form>
                <!--<button type="button" id="enviarmodal" class="btn blue">Save changes</button>-->

            </div>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>

<div class="modal fade" id="basic3" tabindex="-1" role="basic" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{% url 'ncr:observaciones-cerrar' parque.slug %}" method="post" id="formCloseObs">
                {% csrf_token %}
                <input type="hidden" name="back_url" id="back_url" value="">
                <input type="hidden" name="del_id" id="del_id_obs" value="">
                <input type="hidden" name="cerrar" id="cerrar" value="1">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                    <h4 class="modal-title">
                        <span class="glyphicon glyphicon-exclamation-sign" style="color:rgba(255, 63, 0, 0.89);font-size:20px"></span>
                         <b>Advertencia</b> </h4>
                </div>
                <div class="modal-body">
                     <h5><b>Observación no solucionada. Por favor indique la razón para cerrarla.</b> </h5>
                    <textarea id="cierre_msg" name="cierre_msg" class="form-control" rows="3"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn default" data-dismiss="modal">Cancelar</button>
                    <button type="submit" id='enviarmodal' class="btn red" name="FromList">Cerrar Observaci&oacute;n</button>
                        <!--<a href="" id='enviarmodal' class="btn btn-success success">Save Changes</a>-->
                </div>
            </form>
                <!--<button type="button" id="enviarmodal" class="btn blue">Save changes</button>-->
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>

<div class="modal fade" id="basic4" tabindex="-1" role="basic" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{% url 'ncr:observaciones-cerrar' parque.slug %}" method="post" id="formOpenObs">
                {% csrf_token %}
                <input type="hidden" name="back_url" id="back_url" value="">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                    <h4 class="modal-title">
                        <span class="glyphicon glyphicon-exclamation-sign" style="color:rgba(255, 63, 0, 0.89);font-size:20px"></span>
                         <b>Advertencia</b> </h4>
                </div>
                <div class="modal-body">
                     <h5><b>¿Seguro que quiere volver a abrir la observaci&oacute;n?</b> </h5>
                </div>
                <div class="modal-footer">
                        <input type="hidden" name="del_id" id="del_id_obs2" value="">
                        <input type="hidden" name="cerrar" id="cerrar" value="0">
                        <button type="button" class="btn default" data-dismiss="modal">Cancelar</button>
                        <button type="submit" id='enviarmodal' class="btn red" name="FromList">Abrir</button>
                        <!--<a href="" id='enviarmodal' class="btn btn-success success">Save Changes</a>-->
                </div>
            </form>
                <!--<button type="button" id="enviarmodal" class="btn blue">Save changes</button>-->
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>


<div class="modal fade bs-modal-lg" id="duplicar" tabindex="-1" role="basic" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                <h4 class="modal-title">
                    <span class="fa fa-copy" style="color:rgba(74,182,100,0.89);font-size:20px"></span>
                     <b>Duplicar observación</b> </h4>
            </div>
            <form action="{% url 'ncr:observaciones-show' parque.slug observacion.id %}" method="post" id="formDuplicar" class="horizontal-form">
            {% csrf_token %}
            <div class="modal-body">
                <div class="form-body">
                    <div class="row">
                        <label class="control-label col-md-3">{{ duplicarForm.aerogenerador.label }}</label>
                        <div class="col-md-9">
                            <div class="row">
                                {{ duplicarForm.aerogenerador }}
                            </div>
                            <div class="row" style="padding-top: 10px">
                                <div class="col-md-6">
                                    <a href="javascript:;" class="btn btn-sm btn-default" id="sel_todo">
                                         Seleccionar Todo <i class="fa fa-long-arrow-right"></i>
                                    </a>
                                </div>
                                <div class="col-md-6">
                                    <a href="javascript:;" class="btn btn-sm btn-default" id="sel_nada">
                                        <i class="fa fa-long-arrow-left"></i> Deseleccionar
                                    </a>
                                </div>
                            </div>
                        </div>
                        <span class="help-block"> {{ duplicarForm.aerogenerador.errors }} </span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn default" data-dismiss="modal">Cancelar</button>
                <button type="submit" id='enviarmodal' class="btn green" name="duplicar">Duplicar</button>
                    <!--<a href="" id='enviarmodal' class="btn btn-success success">Save Changes</a>-->
                <!--<button type="button" id="enviarmodal" class="btn blue">Save changes</button>-->
            </div>
            </form>
        </div>
        <!-- /.modal-content -->
    </div>
    <!-- /.modal-dialog -->
</div>
{% endblock %}

{% block javascript %}

    {% verbatim %}
        <script id="template-upload" type="text/x-tmpl">
        {% for (var i=0, file; file=o.files[i]; i++) { %}
            <tr class="template-upload fade">
                <td>
                    <span class="preview"></span>
                </td>
                <td>
                    <p class="name">{%=file.name%}</p>
                    <strong class="error text-danger"></strong>
                </td>
                <td>
                    <p class="size">Processing...</p>
                    <div class="progress progress-striped active" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><div class="progress-bar progress-bar-success" style="width:0%;"></div></div>
                </td>
                <td>
                    <p>
                        <label for="option-add" style="margin-right:10px"> Foto informe? </label>
                        <input id="option-add" type="checkbox" name="radio" class="make-switch switch-radio1" data-size="small" data-on-text="Si" data-off-text="No" data-state=true value="{%=file.name%}">
                    </p>
                </td>
                <td style="display: none;">
                {% if (!i && !o.options.autoUpload) { %}
                    <button class="btn btn-primary start" disabled>
                        <i class="glyphicon glyphicon-upload"></i>
                        <span>Comenzar</span>
                    </button>
                {% } %}
                {% if (!i) { %}
                    <button class="btn btn-warning cancel">
                        <i class="glyphicon glyphicon-ban-circle"></i>
                        <span>Cancelar</span>
                    </button>
                {% } %}
                </td>

            </tr>
        {% } %}
        </script>
        <script id="template-download" type="text/x-tmpl">
    {% for (var i=0, file; file=o.files[i]; i++) { %}
        <tr class="template-download fade">
            <td>
                <span class="preview">
                    {% if (file.thumbnailUrl) { %}
                        <a href="{%=file.url%}" title="{%=file.name%}" download="{%=file.name%}" data-gallery><img src="{%=file.thumbnailUrl%}"></a>
                    {% } %}
                </span>
            </td>
            <td>
                <p class="name">
                    {% if (file.url) { %}
                        <a href="{%=file.url%}" title="{%=file.name%}" download="{%=file.name%}" {%=file.thumbnailUrl?'data-gallery':''%}>{%=file.name%}</a>
                    {% } else { %}
                        <span>{%=file.name%}</span>
                    {% } %}
                </p>
                {% if (file.error) { %}
                    <div><span class="label label-danger">Error</span> {%=file.error%}</div>
                {% } %}
            </td>
            <td>
                <span class="size">{%=o.formatFileSize(file.size)%}</span>
            </td>
            <td>
                <p>
                <label for="option-{%=file.photoId%}" style="margin-right:10px"> Foto informe? </label>
                <input id="option-{%=file.photoId%}" type="checkbox" name="radio" class="make-switch switch-radio1" data-size="small" data-on-text="Si" data-off-text="No" data-state=true value="{%=file.name%}">

                {% if (file.deleteUrl) { %}
                    <button class="btn btn-danger btn-sm delete" data-type="{%=file.deleteType%}" data-url="{%=file.deleteUrl%}"{% if (file.deleteWithCredentials) { %} data-xhr-fields='{"withCredentials":true}'{% } %}>
                        <i class="glyphicon glyphicon-trash"></i>
                        <span>Borrar</span>
                    </button>
                    <input type="checkbox" name="delete" value="1" class="toggle">
                {% } else { %}
                    <button class="btn btn-warning cancel">
                        <i class="glyphicon glyphicon-ban-circle"></i>
                        <span>Cancelar</span>
                    </button>
                {% } %}
                </p>
            </td>
        </tr>
    {% } %}
    </script>
    {% endverbatim %}


    <!-- BEGIN PAGE LEVEL PLUGINS -->
    <script src="{% static 'common/assets/global/plugins/bootstrap-switch/js/bootstrap-switch.min.js' %}" type="text/javascript"></script>

    <!-- The Templates plugin is included to render the upload/download listings -->
    <script src="//blueimp.github.io/JavaScript-Templates/js/tmpl.min.js"></script>
    <!-- The Load Image plugin is included for the preview images and image resizing functionality -->
    <script src="//blueimp.github.io/JavaScript-Load-Image/js/load-image.all.min.js"></script>
    <!-- The Canvas to Blob plugin is included for image resizing functionality -->
    <script src="//blueimp.github.io/JavaScript-Canvas-to-Blob/js/canvas-to-blob.min.js"></script>
    <!-- blueimp Gallery script -->
    <script src="//blueimp.github.io/Gallery/js/jquery.blueimp-gallery.min.js"></script>
    <script src="{% static 'common/JQuery-File-Upload/js/vendor/jquery.ui.widget.js' %}" type="text/javascript"></script>
    <script src="{% static 'common/JQuery-File-Upload/js/jquery.iframe-transport.js' %}" type="text/javascript"></script>
    <script src="{% static 'common/JQuery-File-Upload/js/jquery.fileupload.js' %}" type="text/javascript"></script>
    <script src="{% static 'common/JQuery-File-Upload/js/jquery.fileupload-process.js' %}" type="text/javascript"></script>
    <script src="{% static 'common/JQuery-File-Upload/js/jquery.fileupload-image.js' %}" type="text/javascript"></script>
    <script src="{% static 'common/JQuery-File-Upload/js/jquery.fileupload-validate.js' %}" type="text/javascript"></script>
    <script src="{% static 'common/JQuery-File-Upload/js/jquery.fileupload-ui.js' %}" type="text/javascript"></script>
    <script src="{% static 'common/Magnific-Popup/jquery.magnific-popup.min.js' %}" type="text/javascript"></script>

    <script src="{% static 'common/assets/global/scripts/datatable.js' %}" type="text/javascript"></script>
    <script src="{% static 'common/assets/global/plugins/datatables/datatables.min.js' %}" type="text/javascript"></script>
    <script src="{% static 'common/assets/global/plugins/datatables/plugins/bootstrap/datatables.bootstrap.js' %}" type="text/javascript"></script>
    <script src="{% static 'common/js/tabla-imagenes.js' %}" type="text/javascript"></script>

    <script src="{% static 'common/assets/global/plugins/jquery-multi-select/js/jquery.multi-select.js' %}" type="text/javascript"></script>

{% endblock %}

{% block jquery %}
    function csrfSafeMethod(method) {
        // these HTTP methods do not require CSRF protection
        return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
    }

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                var csrftoken = Cookies.get('csrftoken');
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });


    function changeFotoPrincipal(object, revision_id, estado) {
        //console.log(object);
        var id=$(object).attr('id');
        //console.log(id);
        var res = id.split("-");
        if (res.length > 1){
            //console.log(res[1]);
            $.ajax({
                // Uncomment the following to send cross-domain cookies:
                //xhrFields: {withCredentials: true},
                url: "{% url 'ncr:imagenes-primary' parque.slug  %}",
                type: 'POST',
                //dataType: 'json',
                data: {
                    'foto_id': res[1],
                    'estado' : estado
                },
                //context: $('#fileupload')[0]
            }).success(function (result) {
                //console.log("success: Foto primaria agregada.");
                //console.log(result);
                //console.log("thumbnail-"+revision_id);
                $("#thumbnail-"+revision_id).attr('src',result);
            });
        };
    };

    $('.thumbnail img').each(function() {
        var maxWidth = 150; // Max width for the image
        var maxHeight = 150;    // Max height for the image
        var ratio = 0;  // Used for aspect ratio
        var width = $(this).width();    // Current image width
        var height = $(this).height();  // Current image height

        // Check if the current width is larger than the max
        if(width > maxWidth){
            ratio = maxWidth / width;   // get ratio for scaling image
            $(this).css("width", maxWidth); // Set new width
            $(this).css("height", height * ratio);  // Scale height based on ratio
            height = height * ratio;    // Reset height to match scaled image
            width = width * ratio;    // Reset width to match scaled image
        }

        // Check if current height is larger than max
        if(height > maxHeight){
            ratio = maxHeight / height; // get ratio for scaling image
            $(this).css("height", maxHeight);   // Set new height
            $(this).css("width", width * ratio);    // Scale width based on ratio
            width = width * ratio;    // Reset width to match scaled image
        }
        $(this).css("width", maxWidth); // Set new width
        $(this).css("height", maxHeight);
    });

    $("[name='galeria']").each(function( index ) {
        $(this).click(function( index ) {
            //console.log('click!');
            var revision_id = $(this).attr("id").split("-")[1];
            $.magnificPopup.open({
                callbacks: {
                    beforeOpen: function() {
                        //var instance = $(this);
                        $.ajax({
                            url: "{% url 'ncr:fotos-list' parque.slug %}",
                            type: 'POST',
                            dataType: 'json',
                            data: {
                                'revision_id': revision_id
                            }
                        }).done(function (result) {
                            //console.log(result.files);
                            var instance = $.magnificPopup.instance;
                            //console.log(instance);
                            if (result.files.length > 0){
                                instance.items = [];
                            } else {
                                instance.items.pop();
                            }
                            for (i = 0; i < result.files.length; i++) {
                                //console.log(result.files[i].url);
                                instance.items.push({
                                    src: result.files[i].url
                                });
                            };
                            instance.updateItemHTML();
                        });
                    }
                },
                items:[
                        {
                            src:'{% static 'common/images/photo_add6.png' %}'
                        },{
                            src:'{% static 'common/images/photo_add6.png' %}'
                        }
                ],
                gallery:{
                    enabled:true
                },
                type: 'image'
                // other options
            });
        });
    });

    $("[name='addPhoto']").each(function( index ) {
        $(this).click(function( index ) {
            var id=$(this).attr('id');
            //console.log(id);
            var res = id.split("-");

            $('#fileupload').fileupload({
                dataType: 'json',
                // Enable image resizing, except for Android and Opera,
                // which actually support image resizing, but fail to
                // send Blob objects via XHR requests:
                disableImageResize: /Android(?!.*Chrome)|Opera/
                    .test(window.navigator && navigator.userAgent),
                imageMaxWidth: 9000,
                imageMaxHeight: 9000,
                previewMaxWidth: 120,
                previewMaxHeight: 120,
                imageOrientation: true,
                imageCrop: false, // Force cropped images
                sequentialUploads: true,
            })

            $('#fileupload').bind('fileuploadadded', function (e, data) {
                //$.each(data.files, function (index, file) {
                //    console.log('Added file: ' + file.name);
                //});
                $(".switch-radio1").bootstrapSwitch();
                //console.log(data);
                if ($('.switch-radio1:checked').length == 0){
                    $(".switch-radio1").first().bootstrapSwitch('state',true,true);
                }
                $('.switch-radio1').on('switch-change', function () {
                    $('.switch-radio1').bootstrapSwitch('toggleRadioState');
                });
            })

            $('#fileupload').bind('fileuploadcompleted', function (e, data) {
                //console.log('fileuploadcompleted');
                //console.log(data);
                $(".switch-radio1").bootstrapSwitch();
                $.each(data.result.files, function (index, file) {
                    //console.log('Completed file: ' + file.name);
                    if (file.mainPhoto) {
                        $("#option-"+file.photoId).bootstrapSwitch('state',true,true);
                    }
                });
                $('.switch-radio1').on('switchChange.bootstrapSwitch', function () {
                    console.log(".switch-radio1 switchChange.bootstrapSwitch");
                    var estado = $(this).bootstrapSwitch('state');
                    console.log(estado);
                    changeFotoPrincipal($(this),res[1],estado);
                });

            })

            $('#fileupload').bind('fileuploaddone', function (e, data) {
                console.log('upload');
            });

            $('#fileupload').bind('fileuploaddestroy', function (e, data) {
                var principal = data.context.find('input').prop('checked');
                console.log(principal);
                //alert('holis');
                if (principal){
                    //console.log('buscando downloads');
                    if (data.context.siblings("tr.template-download.fade.in").length > 0){
                        var new_principal = data.context.siblings("tr.template-download.fade.in").first().find(".switch-radio1");
                        //$(new_principal).trigger('switchChange.bootstrapSwitch');
                        $(new_principal).bootstrapSwitch('state', true);
                        //console.log($(new_principal));
                        return true;
                    };
                    //console.log('buscando uploads');
                    if (data.context.siblings("tr.template-upload.fade.in").length > 0){
                        var new_principal = data.context.siblings("tr.template-download.fade.in").first().find(".switch-radio1");
                        //$(new_principal).trigger('switchChange.bootstrapSwitch');
                        $(new_principal).bootstrapSwitch('state', true);
                        //console.log($(new_principal));
                        return true;
                    };
                }
            })

            $('#fileupload').addClass('fileupload-processing');

            $.ajax({
                url: "{% url 'ncr:fotos-list' parque.slug %}",
                type: 'POST',
                dataType: 'json',
                context: $('#fileupload')[0],
                data: {
                    'revision_id': res[1]
                }
            }).always(function () {
                $(this).removeClass('fileupload-processing');
            }).done(function (result) {
                //console.log(result);
                $(this).fileupload('option', 'done').call(this, $.Event('done'), {result: result});
            });
        });
    });

    $('#long').on('hidden.bs.modal', function (e) {
        //console.log("Modal se cierra");
        $('#fileupload').fileupload('destroy');
        $("table tbody.files").empty();
    })

    $("#formDelObservacion > #back_url").val("{% url 'ncr:observaciones' parque.slug observacion.aerogenerador.slug %}");
    $("#formDelRevision > #back_url").val(window.location.href);
    $("#formCloseObs > #back_url").val(window.location.href);
    $("#formOpenObs > #back_url").val(window.location.href);

    $("#closeSafe").click(function(){
        $('#del_id_obs').val({{ observacion.id }});
        $('#cierre_msg').val('');
        console.log('CloseSave');
        console.log($("#formCloseObs"));
        $("#formCloseObs").submit();
    });
    $('#imagenes').on('shown.bs.modal', function (e) {
        var revision_id = $(e.relatedTarget).attr('id').split("-")[1];
        //console.log(revision_id);
        //console.log($(e.relatedTarget).attr('data-url'));
        TableDatatablesManaged.init();
        $.ajax({
            url: $(e.relatedTarget).attr('data-url'),
            type: 'GET',
            dataType: 'json'
        }).always(function () {

        }).done(function (result) {
            //console.log(result['data']);
            //var table = TableDatatablesManaged.get_table();
            var table = $('#tabla-imagenes').DataTable();
            $.each(result['data'], function( index, value ) {
                if (value[2]){
                    table.row.add([value[0] ,value[1], '<input type="checkbox" name="my-checkbox" class="switch-2" id="option-' + value[3] + '" checked>']).draw();
                } else {
                    table.row.add([value[0] ,value[1], '<input type="checkbox" name="my-checkbox" class="switch-2" id="option-' + value[3] + '">']).draw();
                }
            });

            $("[name='my-checkbox']").bootstrapSwitch({
                    onText: 'Si',
                    offText: 'No'
            });

            $('.switch-2').on('switchChange.bootstrapSwitch', function () {
                //console.log(".switch-2 switchChange.bootstrapSwitch");
                var estado = $(this).bootstrapSwitch('state');
                //console.log(estado);
                changeFotoPrincipal($(this),revision_id,estado);
            });

            table.on( 'row-reordered', function ( e, diff, edit ) {
                //console.log(e);
                //console.log('Revision='+revision_id.toString());
                var old = [];
                var nuevo = [];
                for ( var i=0, ien=diff.length ; i < ien ; i++ ) {
                    //console.log($(diff[i]));
                    old.push(diff[i].oldData);
                    nuevo.push(diff[i].newData);
                    //console.log(diff[i].oldPosition);
                    //console.log(diff[i].newPosition);
                }
                //console.log(old);
                $.ajax({
                    // Uncomment the following to send cross-domain cookies:
                    //xhrFields: {withCredentials: true},
                    url: "{% url 'ncr:imagenes-orden' parque.slug  %}",
                    type: 'POST',
                    //dataType: 'json',
                    data: {
                        'revision_id': revision_id,
                        'old': old,
                        'new': nuevo,
                    },
                    //context: $('#fileupload')[0]
                }).success(function (result) {
                    console.log(result);
                    console.log($("#thumbnail-"+revision_id));
                    $("#thumbnail-"+revision_id).attr('src',result);

                    //console.log("thumbnail-"+revision_id);

                });
            } );

        });
    });

    $('#imagenes').on('hidden.bs.modal', function (e) {
        var table = $('#tabla-imagenes').DataTable();
        table.clear();
        table.destroy();
    });

    $("#{{ duplicarForm.aerogenerador.auto_id }}").multiSelect();
    $("#sel_todo").click(function(){
        $("#{{ duplicarForm.aerogenerador.auto_id }}").multiSelect('select_all');
        return false;
    });
    $("#sel_nada").click(function(){
        $("#{{ duplicarForm.aerogenerador.auto_id }}").multiSelect('deselect_all');
        return false;
    });

{% endblock %}